\documentclass[10pt]{article}
\usepackage[utf8]{inputenc}

\usepackage{amsmath}
\usepackage{breqn}
\usepackage{mathtools}
\usepackage{geometry}
\geometry{
    a4paper,
    total={170mm,275mm}
}
\usepackage{multicol}
\usepackage{listings}
\setlength\parindent{0pt}

\lstset{
    language=Python,
    basicstyle=\ttfamily, 
    keywordstyle=\bfseries,
    breaklines=true,
    breakatwhitespace=false
}

\pagenumbering{gobble}

\title{Marker Code Trace Reconstruction}
\author{Wan Yiliang}
\date{September 2022}

\begin{document}


\begin{center}
\hrule
\vspace{.4cm}
{\bf {\Huge Marker Code Trace Reconstruction}}
\vspace{.2cm} \\
Wan Yiliang  (A0250640R) 
\end{center}
\vspace{.1cm}
\hrule

\section{Forward-Backward Algorithm}

  \subsection{Forward Messages}

    \begin{equation}
    \begin{aligned}
      f^{M}(i, j) \,&=\, P(s_1...s_i, \pi^M(i, j) | \mathbf{t}) \\
      f^{I\;\;}(i, j) \,&=\, P(s_1...s_i, \pi^{I\;\;}(i, j) | \mathbf{t}) \\
      f^{D\;}(i, j) \,&=\, P(s_1...s_i, \pi^{D\;}(i, j) | \mathbf{t})
    \end{aligned}
    \end{equation}

    \begin{equation} \label{eq111}
    \begin{aligned}
      f^{M}(i, j) \
        &= P(s_1...s_i, \pi^M(i, j) | \mathbf{t}) = \sum\nolimits_{\pi_{prev}} P(s_1...s_i, \pi^M(i, j), \pi_{prev} | \mathbf{t}) \\
        &= P(s_1...s_i, \pi^M(i, j), \pi^M(i-1, j-1) | \mathbf{t}) + P( s_1...s_i, \pi^M(i, j), \pi^{I}(i-1, j-1) | \mathbf{t})  \\
        &\qquad + P(s_1...s_i, \pi^M(i, j), \pi^{D}(i-1, j-1) | \mathbf{t})
    \end{aligned}
    \end{equation}

    First, we examine the first term of (\ref{eq111})

    
    \begin{equation} \label{eq112}
    \begin{aligned}
      P(s_1...s_i,& \pi^M(i, j), \pi^M(i-1, j-1) | \mathbf{t}) \\
        & = P(s_1...s_{i-1} | s_{i}, \pi^M(i, j), \pi^M(i-1, j-1) \mathbf{t}) \times P(s_{i} | \pi^M(i-1, j-1), \pi^M(i, j), \mathbf{t}) \\
          &\qquad \times P(\pi^M(i, j) | \pi^M(i-1, j-1), \mathbf{t}) \times P(\pi^M(i-1, j-1) | \mathbf{t}) \\
        & = P(s_1...s_{i-1} | \pi^M(i-1, j-1) \mathbf{t}) \times P(s_{i} | \pi^M(i, j), \mathbf{t}) \times P(\pi^M(i, j) | \pi^M(i-1, j-1))\\
          &\qquad \times P(\pi^M(i-1, j-1) | \mathbf{t}) \\
        & = P(s_1...s_{i-1} | \pi^M(i-1, j-1) \mathbf{t}) \times P(\pi^M(i-1, j-1) | \mathbf{t}) \times P(\pi^M(i, j) | \pi^M(i-1, j-1)) \\
          &\qquad \times P(s_{i} | \pi^M(i, j), \mathbf{t}) \\
        & = P(s_1...s_{i-1}, \pi^M(i-1, j-1) | \mathbf{t}) \times P(\pi^M(i, j) | \pi^M(i-1, j-1)) \times\ 
        P(s_{i} | \pi^M(i, j), \mathbf{t}) \\
        & = f^{M}(i-1, j-1) \times T_{MM} \times Memission[j](s_{i})
    \end{aligned}
    \end{equation}

    Similar procedures can be applied to the second and the third term of (\ref{eq111})
    \begin{equation} \label{eq113}
      P(\pi^{I}(i-1, j-1), \pi^M(i, j), s_1...s_{i} | \mathbf{t}) = f^{I}(i-1, j-1) \times T_{IM} \times Memission[j](s_{i})
    \end{equation}

    \begin{equation} \label{eq114}
      P(\pi^{D}(i-1, j-1), \pi^M(i, j), s_1...s_{i} | \mathbf{t}) = f^{D}(i-1, j-1) \times T_{DM} \times Memission[j](s_{i})
    \end{equation}
    
    Put (\ref{eq112}) (\ref{eq113}) and (\ref{eq114}) into (\ref{eq111}), and we can obtain the recursion of $f^{M}$
    
    \begin{equation}
      f^{M}(i, j) = (f^{M}(i-1, j-1) \times T_{MM}  + f^{I}(i-1, j-1) \times T_{IM} + f^{D}(i-1, j-1) \times T_{DM}) \times Memission[j](s_{i})
    \end{equation}

    Similarly, we can obtain the recursion formula of $f^{I\;\;}$ and $f^{D\;}$

    \begin{align}
      &\begin{aligned}
        f^{I\;}(i, j) &= \sum\nolimits_{\pi_{prev}} P(s_1...s_{i}, \pi^{I}(i, j), \pi_{prev} | \mathbf{t}) \\
                    &= (f^{M}(i-1, j) \times T_{MI}  + f^{I\;\;}(i-1, j) \times T_{II} + f^{D}(i-1, j) \times T_{DI}) \times Iemission(s_{i})
      \end{aligned} \\
      &\begin{aligned}
        f^{D}(i, j) &= \sum\nolimits_{\pi_{prev}} P(s_1...s_{i}, \pi^{I}(i, j), \pi_{prev} | \mathbf{t}) \\
                    &= f^{M}(i, j-1) \times T_{MD}  + f^{I}(i, j-1) \times T_{ID} + f^{D}(i, j-1) \times T_{DD}
      \end{aligned}
    \end{align}

  \subsection{Backward Messages}
    \begin{equation}
    \begin{aligned}
      b^{M}(i, j) \,&=\, P(s_{i+1}...s_M | \pi^M(i, j), \mathbf{t}) \\
      b^{I\;\;}(i, j) \,&=\, P(s_{i+1}...s_M | \pi^{I\;\;}(i, j), \mathbf{t}) \\
      b^{D\;}(i, j) \,&=\, P(s_{i+1}...s_M | \pi^{D\;}(i, j), \mathbf{t})
    \end{aligned}
    \end{equation}

    \begin{equation} \label{eq121}
    \begin{aligned}
      b^M(i, j) \
        &= P(s_{i+1}...s_M | \pi^{M}(i, j), \mathbf{t}) = \sum\nolimits_{\pi_{next}} P(s_{i+1}...s_M, \pi_{next} | \pi^{M}(i, j), \mathbf{t}) \\
        &= P(s_{i+1}...s_M, \pi^M(i+1, j+1) | \pi^M(i, j), \mathbf{t}) + P(s_{i+1}...s_M, \pi^{I}(i+1, j) | \pi^M(i, j), \mathbf{t})  \\
        &\qquad + P(s_{i+1}...s_M, \pi^{D}(i, j+1)) | \pi^M(i, j), \mathbf{t})
    \end{aligned}
    \end{equation}

    Again, $b^{M}(i, j)$ is the sum of three terms which correspond to three possible next states. Examine the first term of (\ref{eq121}).

    \begin{equation} \label{eq122}
    \begin{aligned}
      P(&s_{i+1}...s_M, \pi^M(i+1, j+1) | \pi^M(i, j), \mathbf{t}) \\
        &= P(s_{i+2}...s_M | s_{i+1}, \pi^M(i+1, j+1), \pi^M(i, j), \mathbf{t}) \
          \times P(s_{i+1}, \pi^M(i+1, j+1) | \pi^M(i, j), \mathbf{t}) \\
        &= P(s_{i+2}...s_M | s_{i+1}, \pi^M(i+1, j+1), \pi^M(i, j), \mathbf{t}) \
          \times P(s_{i+1} | \pi^M(i+1, j+1) \pi^M(i, j), \mathbf{t}) \\
          &\qquad\times P(\pi^M(i+1, j+1) | \pi^M(i, j), \mathbf{t}) \\
        &= P(s_{i+2}...s_M | \pi^M(i+1, j+1), \mathbf{t}) \
          \times P(s_{i+1} | \pi^M(i+1, j+1), \mathbf{t}) \
          \times P(\pi^M(i+1, j+1) | \pi^M(i, j)) \\
        &= b^M(i+1, j+1) \times Memission[j+1](s_{i+1}) \times T_{MM}
    \end{aligned}
    \end{equation}

    Similar procedures can be applied to the second and the third term of (\ref{eq121})

    \begin{align}
      P(s_{i+1}...s_M, \pi^{I\;}(i+1, j) | \pi^M(i, j), \mathbf{t}) \
        &= b^{I\;}(i+1, j) \times Iemission(s_{i+1}) \times T_{MI} \label{eq123}\\
      P(s_{i+1}...s_M, \pi^{D}(i, j+1)) | \pi^M(i, j), \mathbf{t}) \
        &= b^{D}(i, j+1) \times T_{MD} \label{eq124}
    \end{align}

    Put (\ref{eq122}) (\ref{eq123}) and (\ref{eq124}) into (\ref{eq121}), and we can obtain the recursion of $b^{M}$

    \begin{equation}
    \begin{aligned}
      b^M(i, j) \
        &= b^M(i+1, j+1) \times Memission[j+1](s_{i+1}) \times T_{MM} \
          + b^{I}(i+1, j) \times Iemission(s_{i+1}) \times T_{MI} \\
          &\qquad+ b^{D}(i, j+1) \times T_{MD}
    \end{aligned}
    \end{equation}

    Similarly, we can obtain the recursion formula of $b^{I}$ and $b^{D\;}$

    \begin{equation}
    \begin{aligned}
      b^{I\;}(i, j) \
        &= b^M(i+1, j+1) \times Memission[j+1](s_{i+1}) \times T_{IM} \
          + b^{I\;}(i+1, j) \times Iemission(s_{i+1}) \times T_{II} \\
          &\qquad+ b^{D}(i, j+1) \times T_{ID}
    \end{aligned}
    \end{equation}

    \begin{equation}
    \begin{aligned}
      b^{D}(i, j) \
        &= b^M(i+1, j+1) \times Memission[j+1](s_{i+1}) \times T_{DM} \
          + b^{I\;}(i+1, j) \times Iemission(s_{i+1}) \times T_{DI} \\
          &\qquad+ b^{D}(i, j+1) \times T_{DD}
    \end{aligned}
    \end{equation}

  \subsection{Scaling Factors}

    \begin{equation}
    \begin{aligned}
      \widehat{f}^{M}(i, j) \,&=\, P(\pi^M(i, j) | s_1...s_{i}, \mathbf{t}) = \frac{f^{M}(i, j)}{p(s_1...s_{i} | \mathbf{t})} \\
      \widehat{f}^{I\;\;}(i, j) \,&=\, P(\pi^{I\;\;}(i, j) | s_1...s_{i}, \mathbf{t}) = \frac{f^{I}(i, j)}{p(s_1...s_{i} | \mathbf{t})}\\
      \widehat{f}^{D\;}(i, j) \,&=\, P(\pi^{D\;}\,(i, j) | s_1...s_{i}, \mathbf{t}) = \frac{f^{D}(i, j)}{p(s_1...s_{i} | \mathbf{t})}
    \end{aligned}
    \end{equation}

    \begin{equation}
    \begin{aligned}
      \widehat{b}^{M}(i, j) \,&=\, \frac{P(s_{i+1}...s_M | \pi^M(i, j), \mathbf{t})}{p(s_{i+1}...s_M | s_1...s_{i}, \mathbf{t})} = \frac{b^{M}(i, j)}{p(s_{i+1}...s_M | s_1...s_{i}, \mathbf{t})} \\
      \widehat{b}^{I\;\;}(i, j) \,&=\, \frac{P(s_{i+1}...s_M | \pi^{I}(i, j), \mathbf{t})}{p(s_{i+1}...s_M | s_1...s_{i}, \mathbf{t})} = \frac{b^{I}(i, j)}{p(s_{i+1}...s_M | s_1...s_{i}, \mathbf{t})} \\
      \widehat{b}^{D\;}(i, j) \,&=\, \frac{P(s_{i+1}...s_M | \pi^{D}(i, j), \mathbf{t})}{p(s_{i+1}...s_M | s_1...s_{i}, \mathbf{t})} = \frac{b^{D}(i, j)}{p(s_{i+1}...s_M | s_1...s_{i}, \mathbf{t})}
    \end{aligned}
    \end{equation}

    \begin{equation}
      c_{i} = P(s_{i} | s_1...s_{i-1},\mathbf{t})
    \end{equation}
    \begin{equation}
      P(s_1...s_m | \mathbf{t}) = \prod\nolimits_{i=1}^{m} c_i
    \end{equation}

    \begin{align}
      c_{i} \widehat{f}^{M}(i, j) &= (\widehat{f}^{M}(i-1, j-1) \times T_{MM}  + \widehat{f}^{I\;\;}(i-1, j-1) \times T_{IM} + \widehat{f}^{D\;}(i-1, j-1) \times T_{DM}) \\ 
        &\qquad\times Memission[j](s_{i}) \nonumber \\
      c_{i} \widehat{f}^{I\;\;}(i, j) &= (\widehat{f}^{M}(i-1, j) \times T_{MI}  + \widehat{f}^{I\;\;}(i-1, j) \times T_{II} + \widehat{f}^{D\;}(i-1, j) \times T_{DI}) \times Iemission(s_{i}) \\
      \widehat{f}^{D\;}(i, j) &= \widehat{f}^{M}((i, j-1) \times T_{MD}  + \widehat{f}^{I\;\;}((i, j-1) \times T_{ID} + \widehat{f}^{D\;}((i, j-1) \times T_{DD}
    \end{align}

    \begin{equation}
      \sum\nolimits_{j=0}^{N} \left( \pi^{M}(i, j) + \pi^{I\;}(i, j) \right) = 1
    \end{equation}

    \begin{equation}
      \sum\nolimits_{j=0}^{N} \left( \widehat{f}^{M}(i, j) + \widehat{f}^{I\;}(i, j) \right) = 1
    \end{equation}

    \begin{equation}
      c_{i} = \sum\nolimits_{j=0}^{N} \left( \widetilde{f}^{M}(i, j) + \widetilde{f}^{I\;}(i, j) \right)
    \end{equation}

    \begin{equation}
    \begin{aligned}
      c_{i+1} \widehat{b}^{M}(i, j) &= \widehat{b}^M(i+1, j+1) \times Memission[j+1](s_{i+1}) \
        \times T_{MM} + \widehat{b}^{I}(i+1, j) \times Iemission(s_{i+1}) \times T_{MI} \\
                 &\qquad+ c_{i+1} \times \widehat{b}^{D}(i, j+1) \times T_{MD} \\
      c_{i+1} \widehat{b}^{I\;\;}(i, j) &= \widehat{b}^M(i+1, j+1) \times Memission[j+1](s_{i+1}) \
        \times T_{IM} + \widehat{b}^{I}(i+1, j) \times Iemission(s_{i+1}) \times T_{II} \\
                  &\qquad+ c_{i+1} \times \widehat{b}^{D}(i, j+1) \times T_{ID} \\
      c_{i+1} \widehat{b}^{D\;}(i, j) &= \widehat{b}^M(i+1, j+1) \times Memission[j+1](s_{i+1}) \
        \times T_{DM} + \widehat{b}^{I}(i+1, j) \times Iemission(s_{i+1}) \times T_{DI} \\
                  &\qquad+ c_{i+1} \times \widehat{b}^{D}(i, j+1) \times T_{DD}
    \end{aligned}
    \end{equation}

\end{document}
